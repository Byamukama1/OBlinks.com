<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBlinks - Earnings Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <style>
        :root {
            --primary: #1a56db;
            --primary-dark: #1e429f;
            --primary-light: #ebf5ff;
            --secondary: #0e9f6e;
            --light: #f8fafc;
            --dark: #1e293b;
            --gray: #cbd5e1;
            --success: #0e9f6e;
            --warning: #f59e0b;
            --danger: #f05252;
            --card-bg: #fff;
            --border-radius: 10px;
            --shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
        }
        
        body {
            background: var(--light);
            color: var(--dark);
            line-height: 1.6;
            padding: 0;
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(26, 86, 219, 0.03) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(14, 159, 110, 0.03) 0%, transparent 25%);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--gray);
        }
        
        .logo {
            font-weight: 700;
            font-size: 22px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .logo i {
            font-size: 24px;
        }
        
        .nav-links {
            display: flex;
            gap: 15px;
        }
        
        .nav-links a {
            text-decoration: none;
            color: var(--dark);
            font-weight: 500;
            transition: color 0.3s;
            font-size: 14px;
            padding: 5px 8px;
            border-radius: 5px;
        }
        
        .nav-links a:hover, 
        .nav-links a.active {
            color: var(--primary);
            background: var(--primary-light);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }
        
        .dashboard-header {
            text-align: center;
            margin-bottom: 25px;
            padding: 15px 0;
        }
        
        .dashboard-header h1 {
            font-size: 26px;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        .dashboard-header p {
            color: #64748b;
            max-width: 700px;
            margin: 0 auto;
            font-size: 14px;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 16px;
            text-align: center;
            transition: transform 0.3s;
            border-top: 4px solid var(--primary);
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
        }
        
        .stat-icon {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: var(--primary-light);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            color: var(--primary);
            font-size: 18px;
        }
        
        .stat-title {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 6px;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 3px;
        }
        
        .stat-subtitle {
            color: #94a3b8;
            font-size: 12px;
        }
        
        .referral-section {
            background: var(--primary-light);
            border-radius: var(--border-radius);
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-title i {
            font-size: 18px;
        }
        
        .referral-content {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: space-between;
        }
        
        .referral-text {
            flex: 1;
            min-width: 280px;
            color: #1e293b;
            font-size: 14px;
        }
        
        .referral-text strong {
            color: var(--primary);
        }
        
        .referral-link-box {
            flex: 1;
            min-width: 280px;
        }
        
        .referral-link {
            display: flex;
            max-width: 100%;
        }
        
        .referral-link input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--gray);
            border-radius: 8px 0 0 8px;
            font-size: 13px;
        }
        
        .copy-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0 15px;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
            min-width: 80px;
            font-size: 13px;
        }
        
        .copy-btn:hover {
            background: var(--primary-dark);
        }
        
        .tables-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .table-section {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 16px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            font-size: 13px;
        }
        
        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #f1f5f9;
        }
        
        th {
            background: #f8fafc;
            font-weight: 600;
            color: #64748b;
            font-size: 13px;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        tr:hover td {
            background: #f8fafc;
        }
        
        .status {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
            display: inline-block;
        }
        
        .status-paid {
            background: rgba(14, 159, 110, 0.1);
            color: var(--success);
        }
        
        .status-pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }
        
        .withdrawal-form {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 16px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        
        .form-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 15px;
        }
        
        .form-group {
            margin-bottom: 10px;
        }
        
        label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            color: var(--dark);
            font-size: 12px;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--gray);
            border-radius: 8px;
            font-size: 13px;
            transition: all 0.3s;
        }
        
        input:focus, select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(26, 86, 219, 0.15);
        }
        
        .withdraw-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 11px 18px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: 0.3s;
            width: 100%;
            margin-top: 6px;
        }
        
        .withdraw-btn:hover {
            background: var(--primary-dark);
        }
        
        .info-section {
            background: #f1f5f9;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .info-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--primary);
        }
        
        .info-subtitle {
            font-size: 15px;
            font-weight: 600;
            margin: 18px 0 12px;
            color: var(--primary);
        }
        
        .info-text {
            margin-bottom: 12px;
            color: #475569;
            line-height: 1.6;
            font-size: 13px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        
        .package-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: var(--shadow);
            transition: transform 0.3s;
            border-top: 3px solid var(--primary);
        }
        
        .package-card:hover {
            transform: translateY(-3px);
        }
        
        .package-name {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 6px;
            color: var(--primary);
        }
        
        .package-price {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .package-feature {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #f1f5f9;
            font-size: 13px;
        }
        
        .package-feature:last-child {
            border-bottom: none;
        }
        
        .feature-value {
            font-weight: 600;
            color: var(--primary);
            font-size: 13px;
        }
        
        .business-promo {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: var(--border-radius);
            padding: 25px;
            color: white;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .promo-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .promo-text {
            font-size: 15px;
            max-width: 700px;
            margin: 0 auto 18px;
            opacity: 0.9;
        }
        
        .promo-btn {
            background: white;
            color: var(--primary);
            border: none;
            padding: 11px 22px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: 0.3s;
            display: inline-block;
            text-decoration: none;
        }
        
        .promo-btn:hover {
            background: var(--primary-light);
            transform: translateY(-3px);
        }
        
        footer {
            text-align: center;
            padding: 20px 0;
            color: #64748b;
            font-size: 12px;
            border-top: 1px solid var(--gray);
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #64748b;
            font-size: 13px;
        }
        
        .loading-spinner {
            border: 3px solid #f1f5f9;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 35px;
            height: 35px;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }
        
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            display: none;
            font-size: 13px;
        }
        
        .success-message {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            display: none;
            font-size: 13px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 12px;
            }
            
            .dashboard-header h1 {
                font-size: 24px;
            }
            
            .referral-content {
                flex-direction: column;
            }
            
            .business-promo {
                padding: 18px 12px;
            }
            
            .promo-title {
                font-size: 20px;
            }
            
            .promo-text {
                font-size: 14px;
            }
        }
        
        .package-commission {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #cbd5e1;
            font-size: 12px;
            color: #64748b;
        }
        
        .referral-explainer {
            background: #fff;
            border-radius: var(--border-radius);
            padding: 16px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        
        .explainer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .explainer-card {
            background: #f8fafc;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .explainer-card i {
            font-size: 24px;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .explainer-card h4 {
            font-size: 15px;
            margin-bottom: 6px;
            color: var(--primary);
        }
        
        .commission-rate {
            font-weight: 700;
            font-size: 15px;
            color: var(--success);
            margin-top: 4px;
        }
        
        .stat-card.package-stat {
            border-top: 4px solid var(--secondary);
        }
        
        .debug-info {
            background: #f1f5f9;
            border-radius: 8px;
            padding: 10px;
            margin-top: 15px;
            font-size: 12px;
            color: #64748b;
        }
        
        .toggle-table {
            background: var(--primary-light);
            border: none;
            color: var(--primary);
            padding: 7px 12px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-top: 8px;
            transition: all 0.3s;
        }
        
        .toggle-table:hover {
            background: var(--primary);
            color: white;
        }
        
        .toggle-table i {
            transition: transform 0.3s;
        }
        
        .collapsed .toggle-table i {
            transform: rotate(180deg);
        }
        
        .collapsed .table-content {
            display: none;
        }
        
        .compact-table {
            font-size: 12px;
        }
        
        .compact-table th, 
        .compact-table td {
            padding: 8px 10px;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-bottom: 18px;
        }
        
        .stat-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .stat-item-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            margin: 4px 0;
        }
        
        .stat-item-label {
            font-size: 12px;
            color: #64748b;
        }
        
        /* Currency indicator */
        .currency-indicator {
            display: inline-block;
            background: var(--primary-light);
            color: var(--primary);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 5px;
        }
    </style>
</head>


<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-link"></i>
                <span>OBlinks</span>
            </div>
            <div class="nav-links">
                <a href="index.html">Back</a>
                <a href="addbusinessform.html">Add business</a>
                <a href="earn.html" class="active">Earnings</a>
                <a href="myaccount.html">Account</a>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userInitial">JD</div>
                <span id="userName">user name</span>
            </div>
        </header>
        
        <div class="dashboard-header">
            <h1>Business Earnings Dashboard</h1>
            <p>Track your referral earnings and grow your business with OBlinks Online Market</p>
        </div>
        
        <!-- Currency indicator -->
        <div style="text-align: right; margin-bottom: 10px;">
            <span id="currencyDisplay">Currency: <span class="currency-indicator" id="currencySymbol">UGX</span></span>
        </div>
        
        <div class="stats-container">
            <div class="stat-item">
                <div class="stat-item-label">Total Earned</div>
                <div class="stat-item-value" id="totalEarned">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-item-label">Paid Referrals</div>
                <div class="stat-item-value" id="referralCount">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-item-label">Commission Rate</div>
                <div class="stat-item-value" id="commissionRate">30%</div>
            </div>
            <div class="stat-item">
                <div class="stat-item-label">Total Withdrawn</div>
                <div class="stat-item-value" id="totalWithdrawn">0</div>
            </div>
        </div>
        
        <div class="dashboard-grid">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-wallet"></i>
                </div>
                <div class="stat-title">Available Balance</div>
                <div class="stat-value" id="availableBalance">0</div>
                <div class="stat-subtitle">Ready for withdrawal</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-exchange-alt"></i>
                </div>
                <div class="stat-title">Withdrawal Requests</div>
                <div class="stat-value" id="withdrawalRequestsCount">0</div>
                <div class="stat-subtitle">Total requests</div>
            </div>
            
            <div class="stat-card package-stat">
                <div class="stat-icon">
                    <i class="fas fa-crown"></i>
                </div>
                <div class="stat-title">Your Package</div>
                <div class="stat-value" id="userPackage">Basic</div>
                <div class="stat-subtitle">Commission Rate: <span id="userCommissionRate">30%</span></div>
            </div>
        </div>
        
        <div class="referral-explainer">
            <h3 class="section-title"><i class="fas fa-handshake"></i> How Referral Earnings Work</h3>
            <p class="info-text">
                OBlinks rewards you for helping other businesses grow. When you refer a business owner to our platform, 
                you earn a commission when they upgrade to a paid advertising package. This creates a win-win situation: 
                you earn rewards while helping other businesses reach more customers.
            </p>
            
            <div class="explainer-grid">
                <div class="explainer-card">
                    <i class="fas fa-share-alt"></i>
                    <h4>Share Your Link</h4>
                    <p>Share your unique referral link with business owners</p>
                </div>
                
                <div class="explainer-card">
                    <i class="fas fa-store"></i>
                    <h4>Business Joins</h4>
                    <p>They sign up and list their business on OBlinks</p>
                </div>
                
                <div class="explainer-card">
                    <i class="fas fa-chart-line"></i>
                    <h4>Business Upgrades</h4>
                    <p>When they upgrade to a paid package</p>
                </div>
                
                <div class="explainer-card">
                    <i class="fas fa-money-bill-wave"></i>
                    <h4>You Earn Commission</h4>
                    <p>You receive a percentage of their upgrade</p>
                    <div class="commission-rate" id="userCommissionRate">30%</div>
                </div>
            </div>
        </div>
        
        <div class="referral-section">
            <h3 class="section-title"><i class="fas fa-share-alt"></i> Your Referral Link</h3>
            <div class="referral-content">
                <p class="referral-text">
                    Share your unique link with business owners to help them join OBlinks. 
                    <strong>You earn when they upgrade to a paid advertising package</strong>. 
                    Help others grow while growing your own earnings.
                </p>
                <div class="referral-link-box">
                    <div class="referral-link">
                        <input type="text" id="referralLink" value="Generating..." readonly>
                        <button class="copy-btn" onclick="copyReferralLink()">Copy</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>
        
        <div class="tables-container">
            <!-- New Referred Users Table -->
            <div class="table-section">
                <h3 class="section-title">
                    <i class="fas fa-users"></i> Referred businesses 
                    <button class="toggle-table" onclick="toggleTable('referred')">
                        <i class="fas fa-chevron-down"></i> Show More
                    </button>
                </h3>
                <div class="table-content">
                    <div class="loading" id="referredLoading">
                        <div class="loading-spinner"></div>
                        Loading referred users data...
                    </div>
                    <table id="referredTable" class="compact-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>Phone Number</th>
                                <th>Current Package</th>
                                <th>Commission Earned</th>
                            </tr>
                        </thead>
                        <tbody id="referredBody">
                            <!-- Referred users data will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Earnings Table -->
            <div class="table-section">
                <h3 class="section-title">
                    <i class="fas fa-chart-line"></i> Earnings History 
                    <button class="toggle-table" onclick="toggleTable('earnings')">
                        <i class="fas fa-chevron-down"></i> Show More
                    </button>
                </h3>
                <div class="table-content">
                    <div class="loading" id="earningsLoading">
                        <div class="loading-spinner"></div>
                        Loading earnings data...
                    </div>
                    <table id="earningsTable" class="compact-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>Referee</th>
                                <th>Package</th>
                                <th>Amount Paid</th>
                                <th>Commission</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="earningsBody">
                            <!-- Earnings data will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Withdrawals Table -->
            <div class="table-section">
                <h3 class="section-title">
                    <i class="fas fa-history"></i> Withdrawal History 
                    <button class="toggle-table" onclick="toggleTable('withdrawals')">
                        <i class="fas fa-chevron-down"></i> Show More
                    </button>
                </h3>
                <div class="table-content">
                    <div class="loading" id="withdrawalsLoading">
                        <div class="loading-spinner"></div>
                        Loading withdrawal history...
                    </div>
                    <table id="withdrawalsTable" class="compact-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Status</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="withdrawalsBody">
                            <!-- Withdrawals data will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="withdrawal-form">
            <h3 class="form-title"><i class="fas fa-money-check-alt"></i> Request Withdrawal</h3>
            <form id="withdrawalForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="amount">Amount (<span id="currencySymbolForm">UGX</span>)</label>
                        <input type="number" id="amount" placeholder="Minimum 5,000" min="5000" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="method">Withdrawal Method</label>
                        <select id="method" required>
                            <option value="">Select method</option>
                            <option value="mobile_money">Mobile Money</option>
                            <option value="bank_transfer">Bank Transfer</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="details">Account Details</label>
                        <input type="text" id="details" placeholder="Phone number or account details" required>
                    </div>
                </div>
                
                <button type="submit" class="withdraw-btn">Request Withdrawal</button>
            </form>
        </div>
        
        <div class="business-promo">
            <h2 class="promo-title">Grow Your Business with OBlinks</h2>
            <p class="promo-text">Expand your reach and attract more customers by advertising on Uganda's fastest growing business platform</p>
            <a href="#" class="promo-btn">Upgrade Your Business Listing</a>
        </div>
        
        <div class="info-section">
            <h3 class="info-title">Advertising Packages</h3>
            <p class="info-text">
                Businesses on OBlinks can choose from a variety of advertising packages to suit their needs. 
                Each package offers different benefits and exposure levels to help businesses grow.
            </p>
            
            <div class="info-grid">
                <!-- Starter Package -->
                <div class="package-card">
                    <div class="package-name">Starter</div>
                    <div class="package-price" id="starter-price">Free</div>
                    <div class="package-feature">
                        <span>Items Allowed</span>
                        <span class="feature-value">2</span>
                    </div>
                    <div class="package-feature">
                        <span>Featured Placement</span>
                        <span class="feature-value">No</span>
                    </div>
                    <div class="package-commission">
                        Referral Commission: <span class="feature-value">20%</span>
                    </div>
                </div>
                
                <!-- Basic Package -->
                <div class="package-card">
                    <div class="package-name">Basic</div>
                    <div class="package-price" id="basic-price">UGX 30,000/year</div>
                    <div class="package-feature">
                        <span>Items Allowed</span>
                        <span class="feature-value">10</span>
                    </div>
                    <div class="package-feature">
                        <span>Featured Placement</span>
                        <span class="feature-value">Basic</span>
                    </div>
                    <div class="package-commission">
                        Referral Commission: <span class="feature-value">30%</span>
                    </div>
                </div>
                
                <!-- Standard Package -->
                <div class="package-card">
                    <div class="package-name">Standard</div>
                    <div class="package-price" id="standard-price">UGX 40,000/year</div>
                    <div class="package-feature">
                        <span>Items Allowed</span>
                        <span class="feature-value">30</span>
                    </div>
                    <div class="package-feature">
                        <span>Featured Placement</span>
                        <span class="feature-value">Standard</span>
                    </div>
                    <div class="package-commission">
                        Referral Commission: <span class="feature-value">40%</span>
                    </div>
                </div>
                
                <!-- Advanced Package -->
                <div class="package-card">
                    <div class="package-name">Advanced</div>
                    <div class="package-price" id="advanced-price">UGX 50,000/year</div>
                    <div class="package-feature">
                        <span>Items Allowed</span>
                        <span class="feature-value">50</span>
                    </div>
                    <div class="package-feature">
                        <span>Featured Placement</span>
                        <span class="feature-value">Advanced</span>
                    </div>
                    <div class="package-commission">
                        Referral Commission: <span class="feature-value">50%</span>
                    </div>
                </div>
                
                <!-- Professional Package -->
                <div class="package-card">
                    <div class="package-name">Professional</div>
                    <div class="package-price" id="professional-price">UGX 100,000/year</div>
                    <div class="package-feature">
                        <span>Items Allowed</span>
                        <span class="feature-value">70</span>
                    </div>
                    <div class="package-feature">
                        <span>Featured Placement</span>
                        <span class="feature-value">Priority</span>
                    </div>
                    <div class="package-commission">
                        Referral Commission: <span class="feature-value">60%</span>
                    </div>
                </div>
                
                <!-- Premium Package -->
                <div class="package-card">
                    <div class="package-name">Premium</div>
                    <div class="package-price" id="premium-price">UGX 150,000/year</div>
                    <div class="package-feature">
                        <span>Items Allowed</span>
                        <span class="feature-value">90</span>
                    </div>
                    <div class="package-feature">
                        <span>Featured Placement</span>
                        <span class="feature-value">Top Priority</span>
                    </div>
                    <div class="package-commission">
                        Referral Commission: <span class="feature-value">70%</span>
                    </div>
                </div>
                
                <!-- Enterprise Package -->
                <div class="package-card">
                    <div class="package-name">Enterprise</div>
                    <div class="package-price" id="enterprise-price">UGX 200,000/year</div>
                    <div class="package-feature">
                        <span>Items Allowed</span>
                        <span class="feature-value">100</span>
                    </div>
                    <div class="package-feature">
                        <span>Featured Placement</span>
                        <span class="feature-value">Maximum</span>
                    </div>
                    <div class="package-commission">
                        Referral Commission: <span class="feature-value">80%</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="debug-info">
            <p><strong>Debug Info:</strong> Commission rate is determined by your most recent business package</p>
        </div>
        
        <footer>
            <p>Â© 2023 OBlinks - The Global Business Platform. All rights reserved.</p>
            <p>Helping businesses grow through effective online advertising</p>
        </footer>
    </div>
   

   <script>
    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyCGVVpcWS9ae1DH1J8qoaK1TwnSX_W5FkQ",
        authDomain: "oblinks-7fdb1.firebaseapp.com",
        projectId: "oblinks-7fdb1",
        storageBucket: "oblinks-7fdb1.appspot.com",
        messagingSenderId: "587017639779",
        appId: "1:587017639779:web:d11b60f40f431cfc202556"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // DOM elements
    const userInitial = document.getElementById('userInitial');
    const userName = document.getElementById('userName');
    const referralLink = document.getElementById('referralLink');
    const totalEarned = document.getElementById('totalEarned');
    const totalWithdrawn = document.getElementById('totalWithdrawn');
    const availableBalance = document.getElementById('availableBalance');
    const referralCount = document.getElementById('referralCount');
    const userPackage = document.getElementById('userPackage');
    const commissionRate = document.getElementById('commissionRate');
    const userCommissionRate = document.getElementById('userCommissionRate');
    const earningsBody = document.getElementById('earningsBody');
    const withdrawalsBody = document.getElementById('withdrawalsBody');
    const earningsTable = document.getElementById('earningsTable');
    const withdrawalsTable = document.getElementById('withdrawalsTable');
    const earningsLoading = document.getElementById('earningsLoading');
    const withdrawalsLoading = document.getElementById('withdrawalsLoading');
    const withdrawalForm = document.getElementById('withdrawalForm');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');
    const withdrawalRequestsCount = document.getElementById('withdrawalRequestsCount');
    const referredBody = document.getElementById('referredBody');
    const referredTable = document.getElementById('referredTable');
    const referredLoading = document.getElementById('referredLoading');
    const currencySymbol = document.getElementById('currencySymbol');
    const currencySymbolForm = document.getElementById('currencySymbolForm');
    const currencyDisplay = document.getElementById('currencyDisplay');

    // Currency data for conversion
    const currencyData = {
        UG: { name: 'Uganda', symbol: 'UGX', flag: 'ðŸ‡ºðŸ‡¬', conversionRate: 1, format: amount => `UGX ${amount.toLocaleString()}` },
        TZ: { name: 'Tanzania', symbol: 'TZS', flag: 'ðŸ‡¹ðŸ‡¿', conversionRate: 0.63, format: amount => `TZS ${Math.round(amount).toLocaleString()}` },
        GH: { name: 'Ghana', symbol: 'GHâ‚µ', flag: 'ðŸ‡¬ðŸ‡­', conversionRate: 0.00034, format: amount => `GHâ‚µ ${amount.toFixed(2)}` },
        NG: { name: 'Nigeria', symbol: 'â‚¦', flag: 'ðŸ‡³ðŸ‡¬', conversionRate: 0.42, format: amount => `â‚¦${Math.round(amount).toLocaleString()}` }
    };

    // Current user currency data (default to Uganda)
    let userCurrencyData = currencyData.UG;

    // Commission rates mapping
    const commissionRates = {
        "Starter": 20,
        "Basic": 30,
        "Standard": 40,
        "Advanced": 50,
        "Professional": 60,
        "Premium": 70,
        "Enterprise": 80
    };

    // Package base prices in UGX
    const packageBasePrices = {
        "Starter": 0,
        "Basic": 30000,
        "Standard": 40000,
        "Advanced": 50000,
        "Professional": 100000,
        "Premium": 150000,
        "Enterprise": 200000
    };

    // Current user data
    let currentUser = null;
    let userData = null;
    let currentBalance = 0;
    let earningsData = [];
    let withdrawalsData = [];
    let referredUsersData = [];
    let currentCommissionRate = 20; // Default rate

    // Format currency based on user's country
    function formatCurrency(amount) {
        if (!userCurrencyData) return `UGX ${amount.toLocaleString()}`;
        const converted = amount * userCurrencyData.conversionRate;
        return userCurrencyData.format(converted);
    }

    // Format currency without symbol for compact display
    function formatCompactCurrency(amount) {
        if (!userCurrencyData) return amount.toLocaleString();
        const converted = amount * userCurrencyData.conversionRate;
        
        // For currencies with large conversion rates, show rounded numbers
        if (userCurrencyData.conversionRate < 0.1) {
            return Math.round(converted).toLocaleString();
        }
        
        // For currencies with smaller values, show with 2 decimal places
        return converted.toLocaleString(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    // Update package prices display
    function updatePackagePrices() {
        if (!userCurrencyData) return;

        document.querySelectorAll('.package-card .package-price').forEach(element => {
            const packageName = element.closest('.package-card').querySelector('.package-name').textContent;
            const basePrice = packageBasePrices[packageName];
            if (basePrice === undefined) return;
            
            const converted = basePrice * userCurrencyData.conversionRate;
            if (basePrice === 0) {
                element.textContent = 'Free';
            } else {
                element.textContent = userCurrencyData.format(converted) + '/year';
            }
        });
    }

    // Show/hide messages
    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
        setTimeout(() => {
            errorMessage.style.display = 'none';
        }, 5000);
    }

    function showSuccess(message) {
        successMessage.textContent = message;
        successMessage.style.display = 'block';
        setTimeout(() => {
            successMessage.style.display = 'none';
        }, 5000);
    }

    // Toggle table visibility
    function toggleTable(tableType) {
        const button = event.target.closest('button');
        const content = button.closest('.section-title').nextElementSibling;
        
        if (content.style.display === 'none') {
            content.style.display = 'block';
            button.innerHTML = '<i class="fas fa-chevron-up"></i> Show Less';
        } else {
            content.style.display = 'none';
            button.innerHTML = '<i class="fas fa-chevron-down"></i> Show More';
        }
    }

    // Check authentication state
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            userInitial.textContent = user.email ? user.email.charAt(0).toUpperCase() : 'U';
            fetchUserData(user.uid);
        } else {
            sessionStorage.setItem("redirectAfterLogin", window.location.pathname);
            window.location.href = 'login.html';
        }
    });

    // Fetch user data from Firestore
    function fetchUserData(uid) {
        // First get user document
        db.collection("users").doc(uid).get()
        .then(doc => {
            if (doc.exists) {
                userData = doc.data();
                userName.textContent = userData.name || userData.email.split('@')[0];
                
                // Set currency based on user's country
                const countryCode = userData.country || 'UG';
                userCurrencyData = currencyData[countryCode] || currencyData.UG;
                
                // Update currency display
                currencySymbol.textContent = userCurrencyData.symbol;
                currencySymbolForm.textContent = userCurrencyData.symbol;
                currencyDisplay.innerHTML = `Currency: <span class="currency-indicator">${userCurrencyData.symbol}</span>`;
                
                // Generate referral link
                if (userData.whatsapp) {
                    const formattedWhatsapp = userData.whatsapp.startsWith('+') ? 
                        userData.whatsapp.substring(1) : userData.whatsapp;
                    referralLink.value = `https://onlinemarket-ug.com/signup.html?referrer=${formattedWhatsapp}`;
                }
                
                // Get latest business to determine package
                fetchLatestBusinessPackage(uid);
            } else {
                console.log("No such user document!");
                showError("User data not found. Please try again.");
                fetchDashboardData(); // Try to load other data anyway
            }
        })
        .catch(error => {
            console.log("Error getting user document:", error);
            showError("Failed to load user data. Please try again.");
            fetchDashboardData(); // Try to load other data anyway
        });
    }

    // Get latest business to determine package
    function fetchLatestBusinessPackage(uid) {
        db.collection("businesses")
            .where("createdBy", "==", uid)
            .orderBy("timestamp", "desc")
            .limit(1)
            .get()
            .then(snapshot => {
                if (!snapshot.empty) {
                    const latestBusiness = snapshot.docs[0].data();
                    const latestPackage = latestBusiness.package;
                    
                    // Update UI with latest package
                    updatePackageUI(latestPackage);
                } else {
                    // If user has no business, fallback to user document
                    updatePackageUI(userData.package || "Starter");
                }

                // Fetch other dashboard data
                fetchDashboardData();
            })
            .catch(error => {
                console.log("Error getting businesses:", error);
                showError("Failed to load package info.");
                // Fallback to user document package
                updatePackageUI(userData.package || "Starter");
                fetchDashboardData();
            });
    }

    // Update UI with package info
    function updatePackageUI(packageName) {
        userPackage.textContent = packageName;
        currentCommissionRate = commissionRates[packageName] || 20;
        commissionRate.textContent = `${currentCommissionRate}%`;
        userCommissionRate.textContent = `${currentCommissionRate}%`;
    }

    // Fetch all dashboard data
    function fetchDashboardData() {
        // 1. Get earnings data
        const earningsPromise = db.collection("earnings")
            .where("referrerId", "==", currentUser.uid)
            .get();
        
        // 2. Get withdrawals data
        const withdrawalsPromise = db.collection("withdrawals")
            .where("userId", "==", currentUser.uid)
            .get();
        
        // 3. Get referred users
        const referredUsersPromise = db.collection("users")
            .where("referrerWhatsapp", "==", userData.whatsapp)
            .get();
        
        Promise.all([earningsPromise, withdrawalsPromise, referredUsersPromise])
            .then(([earningsSnapshot, withdrawalsSnapshot, referredUsersSnapshot]) => {
                // Process earnings
                let totalEarnings = 0;
                earningsData = [];
                
                earningsSnapshot.forEach(doc => {
                    const earning = doc.data();
                    // Fix: Handle missing timestamps
                    if (!earning.timestamp) {
                        earning.timestamp = doc.createTime; // fallback to document creation time
                    }
                    earningsData.push(earning);
                    totalEarnings += earning.commission || 0;
                });
                
                // Update earnings data with formatted currency
                totalEarned.textContent = formatCompactCurrency(totalEarnings);
                referralCount.textContent = earningsSnapshot.size;
                
                // Build earnings table
                buildEarningsTable();
                
                // Process withdrawals
                withdrawalsData = [];
                let totalWithdrawnAmount = 0;
                let pendingWithdrawnAmount = 0;
                
                withdrawalsSnapshot.forEach(doc => {
                    const data = doc.data();
                    const withdrawal = {
                        id: doc.id,
                        ...data
                    };
                    withdrawalsData.push(withdrawal);
                    
                    if (data.status === 'approved') {
                        totalWithdrawnAmount += data.amount;
                    } else if (data.status === 'pending') {
                        pendingWithdrawnAmount += data.amount;
                    }
                });
                
                // Update withdrawal stats with formatted currency
                totalWithdrawn.textContent = formatCompactCurrency(totalWithdrawnAmount);
                withdrawalRequestsCount.textContent = withdrawalsData.length;
                
                // Calculate available balance
                currentBalance = totalEarnings - (totalWithdrawnAmount + pendingWithdrawnAmount);
                availableBalance.textContent = formatCompactCurrency(Math.max(0, currentBalance));
                
                // Build withdrawals table
                buildWithdrawalsTable();
                
                            // Process referred users
                referredUsersData = [];
                referredUsersSnapshot.forEach(doc => {
                    const user = doc.data();
                    referredUsersData.push(user);
                });
                
                // Build referred users table
                buildReferredUsersTable();
                
                // Update package prices display
                updatePackagePrices();
            })
            .catch(error => {
                console.log("Error getting data:", error);
                showError("Failed to load dashboard data. Please try again.");
            });
    }
    
    // Build earnings table
    function buildEarningsTable() {
        const earningsRows = [];
        
        if (earningsData.length === 0) {
            earningsRows.push(`
                <tr>
                    <td colspan="5" style="text-align: center; padding: 20px;">
                        <i class="fas fa-info-circle" style="color: #64748b; font-size: 20px; margin-bottom: 8px;"></i>
                        <p>No earnings data found</p>
                    </td>
                </tr>
            `);
        } else {
            earningsData.forEach(earning => {
                // Format date - safely handle missing timestamps
                let formattedDate = "N/A";
                if (earning.timestamp && earning.timestamp.toDate) {
                    const date = earning.timestamp.toDate();
                    formattedDate = `${date.getDate()}/${date.getMonth()+1}/${date.getFullYear()}`;
                }
                
                // Add to table
                earningsRows.push(`
                    <tr>
                        <td>${earning.refereeWhatsapp || 'N/A'}</td>
                        <td>${earning.packageBought || 'N/A'}</td>
                        <td>${formatCurrency(earning.amountPaid || 0)}</td>
                        <td>${formatCurrency(earning.commission || 0)}</td>
                        <td>${formattedDate}</td>
                    </tr>
                `);
            });
        }
        
        // Update UI
        earningsBody.innerHTML = earningsRows.join('');
        
        // Hide loading, show table
        earningsLoading.style.display = 'none';
        earningsTable.style.display = 'table';
    }
    
    // Build withdrawals table
    function buildWithdrawalsTable() {
        const withdrawalsRows = [];
        
        if (withdrawalsData.length === 0) {
            withdrawalsRows.push(`
                <tr>
                    <td colspan="4" style="text-align: center; padding: 20px;">
                        <i class="fas fa-info-circle" style="color: #64748b; font-size: 20px; margin-bottom: 8px;"></i>
                        <p>No withdrawal history found</p>
                    </td>
                </tr>
            `);
        } else {
            withdrawalsData.forEach(withdrawal => {
                // Format date
                let formattedDate = "N/A";
                if (withdrawal.timestamp && withdrawal.timestamp.toDate) {
                    const date = withdrawal.timestamp.toDate();
                    formattedDate = `${date.getDate()}/${date.getMonth()+1}/${date.getFullYear()}`;
                }
                
                // Status badge
                const statusClass = withdrawal.status === 'approved' ? 'status-paid' : 
                                  withdrawal.status === 'pending' ? 'status-pending' : 'status-default';
                const statusText = withdrawal.status.charAt(0).toUpperCase() + withdrawal.status.slice(1);
                
                // Add to table
                withdrawalsRows.push(`
                    <tr>
                        <td>${formatCurrency(withdrawal.amount)}</td>
                        <td>${withdrawal.method === 'mobile_money' ? 'Mobile Money' : 'Bank Transfer'}</td>
                        <td><span class="status ${statusClass}">${statusText}</span></td>
                        <td>${formattedDate}</td>
                    </tr>
                `);
            });
        }
        
        // Update UI
        withdrawalsBody.innerHTML = withdrawalsRows.join('');
        
        // Hide loading, show table
        withdrawalsLoading.style.display = 'none';
        withdrawalsTable.style.display = 'table';
    }
    
    // Build referred users table
    function buildReferredUsersTable() {
        const referredRows = [];
        
        if (referredUsersData.length === 0) {
            referredRows.push(`
                <tr>
                    <td colspan="3" style="text-align: center; padding: 20px;">
                        <i class="fas fa-info-circle" style="color: #64748b; font-size: 20px; margin-bottom: 8px;"></i>
                        <p>No referred users found</p>
                    </td>
                </tr>
            `);
        } else {
            // Create a map of commissions by referee
            const commissionByReferee = {};
            earningsData.forEach(earning => {
                if (earning.refereeWhatsapp) {
                    if (!commissionByReferee[earning.refereeWhatsapp]) {
                        commissionByReferee[earning.refereeWhatsapp] = 0;
                    }
                    commissionByReferee[earning.refereeWhatsapp] += earning.commission || 0;
                }
            });
            
            // Add referred users to table
            referredUsersData.forEach(user => {
                const phone = user.whatsapp || 'N/A';
                const package = user.package || 'Starter';
                const commission = commissionByReferee[phone] || 0;
                
                referredRows.push(`
                    <tr>
                        <td>${phone}</td>
                        <td>${package}</td>
                        <td>${formatCurrency(commission)}</td>
                    </tr>
                `);
            });
        }
        
        // Update UI
        referredBody.innerHTML = referredRows.join('');
        
        // Hide loading, show table
        referredLoading.style.display = 'none';
        referredTable.style.display = 'table';
    }
      
    // Copy referral link to clipboard
    function copyReferralLink() {
        referralLink.select();
        referralLink.setSelectionRange(0, 99999);
        document.execCommand("copy");
        
        const btn = document.querySelector('.copy-btn');
        const originalText = btn.textContent;
        btn.textContent = "Copied!";
        
        setTimeout(() => {
            btn.textContent = originalText;
        }, 2000);
        
        showSuccess("Referral link copied to clipboard!");
    }
    
    // Handle withdrawal form submission
    withdrawalForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const amount = parseFloat(document.getElementById('amount').value);
        const method = document.getElementById('method').value;
        const details = document.getElementById('details').value;
        
        // Validate amount
        if (amount < 5000) {
            showError(`Minimum withdrawal amount is ${userCurrencyData.format(5000)}`);
            return;
        }
        
        // Check sufficient balance
        if (amount > currentBalance) {
            showError(`Insufficient balance. Your available balance is ${formatCurrency(currentBalance)}`);
            return;
        }
        
        // Create withdrawal record
        const withdrawalData = {
            userId: currentUser.uid,
            whatsapp: userData.whatsapp,
            amount: amount,
            method: method,
            details: details,
            status: 'pending',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Add to Firestore
        db.collection("withdrawals").add(withdrawalData)
            .then(() => {
                // Show success message
                showSuccess(`Withdrawal request for ${formatCurrency(amount)} has been submitted!`);
                
                // Reset form
                withdrawalForm.reset();
                
                // Refresh data
                fetchDashboardData();
            })
            .catch(error => {
                console.error("Error adding withdrawal: ", error);
                showError('Failed to submit withdrawal request. Please try again.');
            });
    });
    
    // Initialize dashboard when page loads
    document.addEventListener('DOMContentLoaded', () => {
        // Hide all tables initially
        document.querySelectorAll('.table-content').forEach(content => {
            content.style.display = 'none';
        });
        
        // Refresh dashboard every 60 seconds
        setInterval(() => {
            if (currentUser) {
                fetchDashboardData();
            }
        }, 60000);
    });
</script>
</body>
</html>