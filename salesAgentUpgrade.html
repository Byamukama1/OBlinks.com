<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Sales Agent Upgrade – OBlinks</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root{
      --primary:#2563eb;--primary-2:#1e40af;--bg:#f1f5f9;--card:#fff;--muted:#64748b;
      --border:#e2e8f0;--ok:#10b981;--err:#ef4444;--shadow:0 10px 30px rgba(2,6,23,.08)
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif;background:linear-gradient(135deg,#f8fafc,#eef2ff);color:#0f172a;min-height:100vh}
    .wrap{max-width:820px;margin:32px auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
    .head{padding:22px;background:linear-gradient(135deg,var(--primary),#3b82f6);color:#fff}
    .head h1{font-size:1.35rem;font-weight:800}
    .sub{opacity:.95;margin-top:6px}
    .body{padding:20px}
    .section-title{font-weight:800;color:#0f172a;margin:6px 0 10px}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:760px){.grid{grid-template-columns:1.2fr .8fr}}
    table{width:100%;border-collapse:collapse;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    th,td{padding:12px;border-bottom:1px solid var(--border);text-align:left}
    th{background:#f8fafc;font-weight:800}
    .pct{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:800;font-size:.85rem;background:#ecfdf5;color:#065f46}
    .field{margin:10px 0}
    label{font-weight:700;font-size:.92rem;margin-bottom:6px;display:block}
    select,input{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;background:#fff;font-size:1rem}
    .btn{display:inline-flex;align-items:center;gap:10px;width:100%;justify-content:center;
         padding:14px 18px;border:none;border-radius:12px;color:#fff;font-weight:800;cursor:pointer;
         background:linear-gradient(135deg,var(--primary),var(--primary-2));box-shadow:0 10px 20px rgba(37,99,235,.25)}
    .btn:disabled{opacity:.65;cursor:not-allowed;box-shadow:none}
    .status{display:none;margin-top:12px;padding:12px;border-radius:12px;border:1px solid var(--border);background:#f8fafc}
    .status.ok{display:block;border-color:#bbf7d0;background:#ecfdf5;color:#065f46}
    .status.err{display:block;border-color:#fecaca;background:#fef2f2;color:#7f1d1d}
    .note{background:#f8fafc;border:1px dashed var(--border);border-radius:12px;padding:12px;margin-top:10px}
    .footer{padding:16px;text-align:center;color:var(--muted);font-size:.9rem}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="head">
        <h1><i class="fa-solid fa-user-tie"></i> Sales Agent Upgrade</h1>
        <div class="sub">Upgrade your agent package to earn higher commission on every referral.</div>
      </div>

      <div class="body">
        <div class="grid">
          <!-- Left: Compact package table -->
          <div>
            <div class="section-title">Commission Rates by Package</div>
            <p class="muted" style="margin-bottom:10px">
              Pick the package that matches your goals. Higher packages = higher earnings.
            </p>
            <table aria-label="Commission by package">
              <thead>
                <tr><th>Package</th><th>Commission</th><th>Price / year</th></tr>
              </thead>
              <tbody>
                <tr><td>Starter</td><td><span class="pct">20%</span></td><td>UGX 0</td></tr>
                <tr><td>Basic</td><td><span class="pct">30%</span></td><td>UGX 10,000</td></tr>
                <tr><td>Standard</td><td><span class="pct">40%</span></td><td>UGX 30,000</td></tr>
                <tr><td>Advanced</td><td><span class="pct">50%</span></td><td>UGX 50,000</td></tr>
                <tr><td>Professional</td><td><span class="pct">60%</span></td><td>UGX 100,000</td></tr>
                <tr><td>Premium</td><td><span class="pct">70%</span></td><td>UGX 150,000</td></tr>
                <tr><td>Enterprise</td><td><span class="pct">80%</span></td><td>UGX 200,000</td></tr>
              </tbody>
            </table>

            <div class="note">
              Benefits of upgrading:
              <ul style="margin:6px 0 0 18px;line-height:1.55">
                <li>Higher commission on every referral sale</li>
                <li>Priority support & faster approvals at higher tiers</li>
                <li>Recognition as a top-performing OBlinks agent</li>
              </ul>
            </div>
          </div>

          <!-- Right: Payment form -->
          <div>
            <div class="section-title">Upgrade & Pay</div>

            <div class="field">
              <label for="pkg">Select Package</label>
              <select id="pkg">
                <option value="" selected disabled>-- Choose package --</option>
                <option value="Starter"       data-amount="0">Starter — 20% — UGX 0</option>
                <option value="Basic"         data-amount="10000">Basic — 30% — UGX 10,000</option>
                <option value="Standard"      data-amount="30000">Standard — 40% — UGX 30,000</option>
                <option value="Advanced"      data-amount="50000">Advanced — 50% — UGX 50,000</option>
                <option value="Professional"  data-amount="100000">Professional — 60% — UGX 100,000</option>
                <option value="Premium"       data-amount="150000">Premium — 70% — UGX 150,000</option>
                <option value="Enterprise"    data-amount="200000">Enterprise — 80% — UGX 200,000</option>
              </select>
            </div>

            <div class="field">
              <label for="phone">Payment Phone (MTN/Airtel – Uganda)</label>
              <input id="phone" type="tel" placeholder="2567XXXXXXXX or 07XXXXXXXX" autocomplete="tel">
            </div>

            <button id="payBtn" class="btn">
              <i class="fa-solid fa-lock"></i> Pay with Pandora (Mobile Money)
            </button>
            <div id="status" class="status"></div>

            <div class="note" style="margin-top:12px">
              Amounts are in UGX. Use a valid number like <b>25676XXXXXXX</b> (or type <b>07XXXXXXXX</b> and we’ll convert it).  
              Note: numbers starting with <b>079</b> aren’t supported.
            </div>
          </div>
        </div>
      </div>

      <div class="footer">© OBlinks — Sales Agent Program</div>
    </div>
  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    // ===== Backend =====
    const API_BASE = "https://oblinks-new-server-pandora-payments.onrender.com";

    // ===== Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyCGVVpcWS9ae1DH1J8qoaK1TwnSX_W5FkQ",
      authDomain: "oblinks-7fdb1.firebaseapp.com",
      projectId: "oblinks-7fdb1",
      storageBucket: "oblinks-7fdb1.appspot.com",
      messagingSenderId: "587017639779",
      appId: "1:587017639779:web:d11b60f40f431cfc202556"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    // ===== Helpers =====
    const $ = s => document.querySelector(s);
    function showStatus(text, ok=false){
      const el = $("#status");
      el.textContent = text;
      el.className = "status " + (ok ? "ok" : "err");
      el.style.display = "block";
    }
    // Uganda E.164 + block 079
    function toE164Ug(raw){
      let p = String(raw||"").replace(/\D/g,"");
      if(/^0\d{8,9}$/.test(p)) p = "256" + p.slice(1);
      if(p.startsWith("25679")) return {valid:false,reason:"079 prefix is not supported."};
      if(/^256\d{9}$/.test(p)) return {valid:true,phone:p};
      return {valid:false,reason:"Use 256XXXXXXXXX or 0XXXXXXXXX"};
    }

    // ===== State =====
    let currentUser = null;

    auth.onAuthStateChanged(async (user)=>{
      if(!user){
        alert("Please log in first.");
        location.href = "login.html";
        return;
      }
      currentUser = user;
      // Optional prefill from users doc if present
      try{
        const snap = await db.collection("users").doc(user.uid).get();
        const phone = snap.exists ? (snap.data().phone || snap.data().whatsapp || "") : "";
        if(phone) $("#phone").value = phone;
      }catch(_){}
    });

    // ===== Pay with Pandora (Agent upgrade) =====
    $("#payBtn").addEventListener("click", async ()=>{
      if(!currentUser) return showStatus("User not authenticated.");
      const opt = $("#pkg").selectedOptions[0];
      if(!opt)   return showStatus("Please choose a package.");
      const packageName = opt.value;
      const amount = Number(opt.dataset.amount || 0);

      const p = toE164Ug($("#phone").value);
      if(!p.valid) return showStatus(p.reason);

      try{
        $("#payBtn").disabled = true;
        showStatus("Starting mobile money request… check your phone.", true);

        // Log payment intent (type = agent-upgrade)
        await db.collection("payments").add({
          provider: "pandora",
          status: "initiated",
          amountPaid: amount,
          currency: "UGX",
          paymentPhone: p.phone,
          packageName,
          type: "agent-upgrade",
          userId: currentUser.uid,
          timestamp: new Date()
        });

        // Call backend to initiate Pandora payment
        const narrative = `OBlinks Agent Upgrade - ${packageName}`;
        const res = await fetch(`${API_BASE}/api/pay`,{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({
            amount,
            phone: p.phone,
            userId: currentUser.uid,
            businessId: "",          // not used for agent upgrade
            packageName,
            narrative
          })
        });

        const txt = await res.text();
        let data=null; try{ data = JSON.parse(txt) }catch{}
        if(res.ok && (data?.transaction_ref || data?.success)){
          showStatus("Prompt sent to your phone. Approve to complete the upgrade.", true);
        }else{
          const msg = (data && (data.error || (data.messages||[]).join(" "))) || txt || "Payment failed to start.";
          showStatus(msg);
        }
      }catch(err){
        console.error(err);
        showStatus("Network/server error: " + err.message);
      }finally{
        $("#payBtn").disabled = false;
      }
    });
  </script>
</body>
</html>