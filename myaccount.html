<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Account | OBlinks</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <style>
    /* Global Styles */
    :root { 
      --primary: #2563eb; 
      --primary-dark: #1d4ed8; 
      --secondary: #64748b; 
      --light: #f8fafc; 
      --dark: #1e293b; 
      --success: #10b981; 
      --warning: #f59e0b; 
      --error: #ef4444; 
      --accent: #8b5cf6; 
      --bg: #f1f5f9; 
      --border: #e2e8f0; 
      --card-bg: #ffffff; 
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    
    body { 
      background-color: var(--bg); 
      color: var(--dark); 
      line-height: 1.6; 
      min-height: 100vh;
      font-family: 'Poppins', sans-serif;
    }  
    
    /* Header Styles */
    header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 15px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      z-index: 100;
      position: sticky;
      top: 0;
    }
    
    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 15px;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .logo-text h1 {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 1px;
    }
    
    .tagline {
      font-size: 13px;
      opacity: 0.9;
    }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    /* Main Account Layout */
    .account-container {
      max-width: 1200px;
      margin: 30px auto;
      padding: 0 20px;
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 25px;
    }
    
    @media (max-width: 768px) {
      .account-container {
        grid-template-columns: 1fr;
      }
    }
    
    /* Account Sidebar */
    .account-sidebar {
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      padding: 25px;
      height: fit-content;
    }
    
    .user-profile {
      text-align: center;
      padding-bottom: 20px;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }
    
    .profile-pic {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      margin: 0 auto 15px;
      position: relative;
      overflow: hidden;
      background: #eef2ff;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
      font-size: 40px;
    }
    
    .profile-pic img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .change-photo {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.6);
      color: white;
      font-size: 12px;
      padding: 5px;
      cursor: pointer;
    }
    
    .user-name {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .user-email {
      color: var(--secondary);
      font-size: 14px;
    }
    
    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 15px;
      margin-bottom: 8px;
      border-radius: 8px;
      color: var(--dark);
      text-decoration: none;
      transition: all 0.3s ease;
    }
    
    .nav-item:hover, .nav-item.active {
      background: #eef2ff;
      color: var(--primary);
    }
    
    .nav-item i {
      width: 24px;
      text-align: center;
    }
    
    /* Account Content */
    .account-content {
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      padding: 30px;
      margin-bottom: 40px;
    }
    
    .section-title {
      font-size: 24px;
      color: var(--primary-dark);
      margin-bottom: 25px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    /* Profile Section */
    .profile-form {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 25px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark);
    }
    
    .form-control {
      width: 100%;
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s ease;
      background: white;
    }
    
    .form-control:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .btn {
      padding: 12px 25px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 16px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      border: none;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    /* Dashboard Cards */
    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      text-align: center;
    }
    
    .stat-icon {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: rgba(37, 99, 235, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 15px;
      color: var(--primary);
      font-size: 24px;
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 5px;
      color: var(--dark);
    }
    
    .stat-label {
      color: var(--secondary);
      font-size: 16px;
    }
    
    /* Withdraw History */
    .withdraw-list {
      list-style: none;
    }
    
    .withdraw-item {
      padding: 15px;
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    .withdraw-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #eef2ff;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
      flex-shrink: 0;
    }
    
    .withdraw-content {
      flex-grow: 1;
    }
    
    .withdraw-title {
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .withdraw-time {
      color: var(--secondary);
      font-size: 13px;
      margin-top: 5px;
    }
    
    /* Modal Enhancements */
    #cropModal { 
      display: none; 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0, 0, 0, 0.7); 
      justify-content: center; 
      align-items: center; 
      z-index: 9999; 
    }

    #cropModalContent { 
      background: white; 
      padding: 20px; 
      border-radius: 12px; 
      max-width: 90vw; 
      max-height: 90vh; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
    }

    #cropperImage { 
      max-width: 100%; 
      max-height: 60vh; 
      margin-bottom: 20px; 
      border-radius: 8px; 
    }

    #cropAndUploadBtn { 
      padding: 10px 18px; 
      background: var(--primary); 
      color: white; 
      border: none; 
      border-radius: 8px; 
      font-weight: 600; 
      transition: background 0.3s ease; 
    }

    #cropAndUploadBtn:disabled { 
      background: var(--secondary); 
      cursor: not-allowed;
    }
    
    /* Content sections */
    .content-section {
      display: none;
    }
    
    .content-section.active {
      display: block;
    }
    /* Responsive Design */
    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .dashboard-cards {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 480px) {
      .account-content {
        padding: 20px;
      }
    }
    
    /* Status indicators */
    .status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status.pending {
      background-color: #fef3c7;
      color: #d97706;
    }
    
    .status.completed {
      background-color: #dcfce7;
      color: #15803d;
    }
    
    .status.failed {
      background-color: #fee2e2;
      color: #b91c1c;
    }
    
    /* Change Password Form */
    .password-form {
      max-width: 500px;
      margin: 0 auto;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
    }
    
    .password-strength {
      height: 5px;
      background: #e2e8f0;
      border-radius: 3px;
      margin-top: 5px;
      overflow: hidden;
    }
 .strength-meter {
      height: 100%;
      width: 0;
      background: var(--error);
      transition: width 0.3s ease, background 0.3s ease;
    }
    
    .password-hints {
      margin-top: 10px;
      color: var(--secondary);
      font-size: 13px;
    }
    
    /* Loading spinner */
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border-left-color: var(--primary);
      animation: spin 1s linear infinite;
      margin: 20px auto;
      display: none;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="header-content">
      <div class="logo">
        <div class="logo-text">
          <h1>OBlinks</h1>
          <p class="tagline">Global Business Platform</p>
        </div>
      </div>
    </div>
  </header>
  
  <!-- Main Account Container -->
  <div class="account-container">
    <!-- Sidebar Navigation -->
    <div class="account-sidebar">
      <div class="user-profile">
        <div class="profile-pic">
          <img id="userImage" src="https://via.placeholder.com/100" alt="Profile">
          <div class="change-photo">
            <label for="profileImageUpload" style="cursor:pointer;">Change</label>
            <input type="file" id="profileImageUpload" accept="image/*" style="display:none" />
          </div>
        </div>
        <div class="user-name" id="userName">Loading...</div>
        <div class="user-email" id="userEmail">Loading...</div>
      </div>
      
      <nav class="account-nav">
          <!-- New DOWNLOAD APP button -->
  <a href="https://oblinksonlinemarketapp.netlify.app" target="_blank" class="nav-item">
    <i class="fas fa-download"></i> Download OBlinks App
  </a>


        <a href="editbusiness.html" class="nav-item">
  <i class="fas fa-edit"></i> Edit your business 
</a>
    
        <a href="earn.html" class="nav-item">
          <i class="fas fa-chart-line"></i> Earnings
        </a>
      
        <a href="https://wa.me/256761828694" target="_blank" class="nav-item">
          <i class="fas fa-headset"></i> Customer Care
        </a>
        <a href="notifications.html" class="nav-item">
          <i class="fas fa-bell"></i> Notifications
        </a>
        <a href="userguide.html" class="nav-item" data-section="logout">
          <i class="fas fa-sign-out-alt"></i> User Guide 
        </a>
         <a href="#" class="nav-item active" data-section="profile">
          <i class="fas fa-user"></i> Profile(scroll)
        </a>
      </nav>
    </div>
    
    <!-- Account Content -->
    <div class="account-content">
      <!-- Profile Section -->
      <div id="profile" class="content-section active">
        <div class="section-title">
          <i class="fas fa-user"></i>
          <h2>Profile Information</h2>
        </div>
        <form id="profileForm" class="profile-form">
          <div class="form-group">
            <label for="name">Full Name</label>
            <input type="text" id="name" class="form-control" placeholder="Enter your full name">
          </div>
          <div class="form-group">
            <label for="email">Email Address</label>
            <input type="email" id="email" class="form-control" placeholder="Enter your email" disabled>
          </div>
          <div class="form-group">
            <label for="phone">Phone Number</label>
            <input type="tel" id="phone" class="form-control" placeholder="Enter your phone number">
          </div>
          <div class="form-group">
            <label for="country">Country</label>
            <select id="country" class="form-control">
              <option value="">Select your country</option>
              <option value="ug">Uganda</option>
              <option value="ke">Kenya</option>
              <option value="ng">Nigeria</option>
              <option value="za">South Africa</option>
              <option value="tz">Tanzania</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> Save Changes
          </button>
        </form>
      </div>
      
      <!-- Change Password Section -->
      <div id="change-password" class="content-section">
        <div class="section-title">
          <i class="fas fa-key"></i>
          <h2>Change Password</h2>
        </div>
        <form id="passwordForm" class="password-form">
          <div class="form-group">
            <label for="currentPassword">Current Password</label>
            <input type="password" id="currentPassword" class="form-control" placeholder="Enter your current password">
          </div>
          
          <div class="form-group">
            <label for="newPassword">New Password</label>
            <input type="password" id="newPassword" class="form-control" placeholder="Enter new password">
            <div class="password-strength">
              <div class="strength-meter" id="strengthMeter"></div>
            </div>
            <div class="password-hints">
              <p>Password must be at least 8 characters and include:</p>
              <ul>
                <li>Uppercase letter</li>
                <li>Lowercase letter</li>
                <li>Number</li>
                <li>Special character</li>
              </ul>
            </div>
          </div>
          
          <div class="form-group">
            <label for="confirmPassword">Confirm New Password</label>
            <input type="password" id="confirmPassword" class="form-control" placeholder="Confirm new password">
          </div>
          
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-sync-alt"></i> Update Password
          </button>
          <div class="spinner" id="passwordSpinner"></div>
        </form>
      </div>
      
      <!-- Withdraw History Section -->
      <div id="withdraw-history" class="content-section">
        <div class="section-title">
          <i class="fas fa-money-bill-wave"></i>
          <h2>Withdrawal History</h2>
        </div>
        
        <div class="dashboard-cards">
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-wallet"></i>
            </div>
            <div class="stat-value" id="totalWithdrawals">$0.00</div>
            <div class="stat-label">Total Withdrawn</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-clock"></i>
            </div>
            <div class="stat-value" id="pendingWithdrawals">0</div>
            <div class="stat-label">Pending Requests</div>
          </div>
        </div>
        
        <div class="section-title">
          <i class="fas fa-history"></i>
          <h2>Recent Withdrawals</h2>
        </div>
        
        <ul class="withdraw-list" id="withdrawList">
          <li class="withdraw-item">
            <div class="withdraw-icon">
              <i class="fas fa-spinner"></i>
            </div>
            <div class="withdraw-content">
              <div class="withdraw-title">Loading your withdrawal history...</div>
            </div>
          </li>
        </ul>
      </div>
   <!-- Logout Section -->
      <div id="logout" class="content-section">
        <div class="logout-container">
          <div class="logout-icon">
            <i class="fas fa-sign-out-alt"></i>
          </div>
          <h2>Are you sure you want to log out?</h2>
          <p>You will need to sign in again to access your account</p>
          <div style="margin-top: 30px;">
            <button id="confirmLogout" class="btn btn-primary" style="background: var(--error); margin-right: 10px;">
              <i class="fas fa-sign-out-alt"></i> Yes, Log Out
            </button>
            <button id="cancelLogout" class="btn">
              <i class="fas fa-times"></i> Cancel
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Image Crop Modal -->
  <div id="cropModal">
    <div id="cropModalContent">
      <img id="cropperImage" />
      <div style="text-align:right; margin-top:15px;">
        <button id="cropAndUploadBtn">Crop & Upload</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { 
      getFirestore, 
      doc, 
      setDoc, 
      getDoc,
      collection,
      query,
      where,
      getDocs,
      orderBy,
      limit
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
    import { 
      getAuth, 
      onAuthStateChanged, 
      signOut, 
      updatePassword,
      reauthenticateWithCredential,
      EmailAuthProvider
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCGVVpcWS9ae1DH1J8qoaK1TwnSX_W5FkQ",
      authDomain: "oblinks-7fdb1.firebaseapp.com",
      projectId: "oblinks-7fdb1",
      storageBucket: "oblinks-7fdb1.appspot.com",
      messagingSenderId: "587017639779",
      appId: "1:587017639779:web:d11b60f40f431cfc202556"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
       // DOM Elements
    const profileInput = document.getElementById("profileImageUpload");
    const cropModal = document.getElementById("cropModal");
    const cropperImage = document.getElementById("cropperImage");
    const cropAndUploadBtn = document.getElementById("cropAndUploadBtn");
    const profileForm = document.getElementById("profileForm");
    const nameInput = document.getElementById("name");
    const emailInput = document.getElementById("email");
    const phoneInput = document.getElementById("phone");
    const countrySelect = document.getElementById("country");
    const navItems = document.querySelectorAll(".nav-item");
    const contentSections = document.querySelectorAll(".content-section");
    const confirmLogoutBtn = document.getElementById("confirmLogout");
    const cancelLogoutBtn = document.getElementById("cancelLogout");
    const passwordForm = document.getElementById("passwordForm");
    const currentPasswordInput = document.getElementById("currentPassword");
    const newPasswordInput = document.getElementById("newPassword");
    const confirmPasswordInput = document.getElementById("confirmPassword");
    const strengthMeter = document.getElementById("strengthMeter");
    const passwordSpinner = document.getElementById("passwordSpinner");
    const withdrawList = document.getElementById("withdrawList");
    const totalWithdrawals = document.getElementById("totalWithdrawals");
    const pendingWithdrawals = document.getElementById("pendingWithdrawals");

    let cropper;
    let currentUserId;
    let currentUser;

    // Check authentication status
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        currentUserId = user.uid;
        await loadUserData();
        await loadWithdrawalHistory();
      } else {
        // Redirect to login if not authenticated
        window.location.href = "login.html";
      }
    });

    // 🔄 Load User Data
    async function loadUserData() {
      const userRef = doc(db, "users", currentUserId);
      const userSnap = await getDoc(userRef);
      
      if (userSnap.exists()) {
        const data = userSnap.data();
        document.getElementById("userImage").src = data.profileImage || "https://via.placeholder.com/100";
        document.getElementById("userName").innerText = data.name || "User";
        document.getElementById("userEmail").innerText = currentUser.email || "";
        
        // Fill profile form
        nameInput.value = data.name || "";
        emailInput.value = currentUser.email || "";
        phoneInput.value = data.phone || "";
        countrySelect.value = data.country || "";
      } else {
        // Create user document if it doesn't exist
        await setDoc(userRef, {
          name: currentUser.displayName || "User",
          email: currentUser.email,
          profileImage: "https://via.placeholder.com/100",
          createdAt: new Date()
        });
        
        document.getElementById("userImage").src = "https://via.placeholder.com/100";
        document.getElementById("userName").innerText = currentUser.displayName || "User";
        document.getElementById("userEmail").innerText = currentUser.email || "";
      }
    }

    // 💰 Load Withdrawal History
    async function loadWithdrawalHistory() {
      withdrawList.innerHTML = '<li class="withdraw-item"><div class="withdraw-icon"><i class="fas fa-spinner fa-spin"></i></div><div class="withdraw-content"><div class="withdraw-title">Loading your withdrawal history...</div></div></li>';
      
      const q = query(
        collection(db, "withdrawals"),
        where("userId", "==", currentUserId),
        orderBy("timestamp", "desc"),
        limit(10)
      );
      
      try {
        const querySnapshot = await getDocs(q);
        
        if (querySnapshot.empty) {
          withdrawList.innerHTML = '<li class="withdraw-item"><div class="withdraw-icon"><i class="fas fa-info-circle"></i></div><div class="withdraw-content"><div class="withdraw-title">No withdrawal history found</div><p>You haven\'t made any withdrawal requests yet</p></div></li>';
          totalWithdrawals.textContent = "$0.00";
          pendingWithdrawals.textContent = "0";
          return;
        }
        
        let totalAmount = 0;
        let pendingCount = 0;
        let withdrawalsHtml = "";
        
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          const amount = data.amount || 0;
          const status = data.status || "pending";
          const method = data.method || "Unknown";
          const timestamp = data.timestamp ? data.timestamp.toDate() : new Date();
          
          // Format date
          const formattedDate = timestamp.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
          
          // Add to totals
          if (status === "completed") {
            totalAmount += amount;
          }
          if (status === "pending") {
            pendingCount++;
          }
          
          // Status styling
          let statusClass = "pending";
          let statusIcon = "fas fa-spinner";
          
          if (status === "completed") {
            statusClass = "completed";
            statusIcon = "fas fa-check-circle";
          } else if (status === "failed") {
            statusClass = "failed";
            statusIcon = "fas fa-times-circle";
          }
          
          withdrawalsHtml += `
            <li class="withdraw-item">
              <div class="withdraw-icon">
                <i class="${statusIcon}"></i>
              </div>
              <div class="withdraw-content">
                <div class="withdraw-title">${method} Withdrawal</div>
                <p>Amount: $${amount.toFixed(2)}</p>
                <div class="withdraw-time">
                  ${formattedDate} · 
                  <span class="status ${statusClass}">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
                </div>
              </div>
            </li>
          `;
        });
        
        withdrawList.innerHTML = withdrawalsHtml;
        totalWithdrawals.textContent = `$${totalAmount.toFixed(2)}`;
        pendingWithdrawals.textContent = pendingCount;
      } catch (error) {
        console.error("Error loading withdrawal history:", error);
        withdrawList.innerHTML = '<li class="withdraw-item"><div class="withdraw-icon"><i class="fas fa-exclamation-triangle"></i></div><div class="withdraw-content"><div class="withdraw-title">Error loading withdrawals</div><p>Please try again later</p></div></li>';
      }
    }

    // Handle profile form submission
    profileForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      try {
        const userRef = doc(db, "users", currentUserId);
        
        await setDoc(userRef, {
          name: nameInput.value,
          phone: phoneInput.value,
          country: countrySelect.value
        }, { merge: true });
        
        document.getElementById("userName").innerText = nameInput.value;
        
        // Show success message
        const successMsg = document.createElement('div');
        successMsg.innerHTML = '<i class="fas fa-check-circle"></i> Profile updated successfully!';
        successMsg.style.backgroundColor = 'var(--success)';
        successMsg.style.color = 'white';
        successMsg.style.padding = '10px';
        successMsg.style.borderRadius = '8px';
        successMsg.style.marginTop = '15px';
        successMsg.style.textAlign = 'center';
        profileForm.appendChild(successMsg);
        
        // Remove message after 3 seconds
        setTimeout(() => {
          successMsg.remove();
        }, 3000);
      } catch (error) {
        console.error("Error updating profile:", error);
        alert("Error updating profile. Please try again.");
      }
    });

    // 📸 Cropper Modal
    profileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        cropperImage.src = URL.createObjectURL(file);
        cropModal.style.display = "flex";
        if (cropper) cropper.destroy();
        cropper = new Cropper(cropperImage, {
          aspectRatio: 1,
          viewMode: 1,
          background: false,
        });
      }
    });

    // ☁️ Upload to Cloudinary
    cropAndUploadBtn.addEventListener("click", async () => {
      if (!cropper) {
        alert("Please select and crop an image first.");
        return;
      }

      const canvas = cropper.getCroppedCanvas({ width: 300, height: 300 });
      canvas.toBlob(async (blob) => {
        const formData = new FormData();
        formData.append("file", blob);
        formData.append("upload_preset", "Unsigned upload");

        try {
          const res = await fetch("https://api.cloudinary.com/v1_1/dp81zzxlh/image/upload", {
            method: "POST",
            body: formData,
          });

          const data = await res.json();
          const imageUrl = data.secure_url;

          if (!imageUrl) {
            alert("Upload failed. No image URL returned.");
            return;
          }

          const userRef = doc(db, "users", currentUserId);
          await setDoc(userRef, { profileImage: imageUrl }, { merge: true });

          document.getElementById("userImage").src = imageUrl;
          cropModal.style.display = "none";
          alert("✅ Profile picture updated!");
        } catch (err) {
          console.error("Upload error:", err);
          alert("❌ Something went wrong during upload.");
        }
      }, "image/jpeg");
    });

    // Password strength indicator
    newPasswordInput.addEventListener("input", () => {
      const password = newPasswordInput.value;
      let strength = 0;
      
      // Length check
      if (password.length >= 8) strength += 25;
      if (password.length >= 12) strength += 10;
      
      // Character diversity
      if (/[A-Z]/.test(password)) strength += 20;
      if (/[a-z]/.test(password)) strength += 20;
      if (/[0-9]/.test(password)) strength += 20;
      if (/[^A-Za-z0-9]/.test(password)) strength += 20;
      
      // Update meter
      strength = Math.min(strength, 100);
      strengthMeter.style.width = strength + "%";
      
      // Update color
      if (strength < 40) {
        strengthMeter.style.backgroundColor = "var(--error)";
      } else if (strength < 70) {
        strengthMeter.style.backgroundColor = "var(--warning)";
      } else {
        strengthMeter.style.backgroundColor = "var(--success)";
      }
    });

    // Change password form
    passwordForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const currentPassword = currentPasswordInput.value;
      const newPassword = newPasswordInput.value;
      const confirmPassword = confirmPasswordInput.value;
      
      // Validation
      if (!currentPassword || !newPassword || !confirmPassword) {
        alert("Please fill in all fields");
        return;
      }
      
      if (newPassword !== confirmPassword) {
        alert("New passwords do not match");
        return;
      }
      
      if (newPassword.length < 8) {
        alert("Password must be at least 8 characters");
        return;
      }
      
      // Show spinner
      passwordSpinner.style.display = "block";
      
      try {
        // Reauthenticate user
        const credential = EmailAuthProvider.credential(
          currentUser.email,
          currentPassword
        );
        
        await reauthenticateWithCredential(currentUser, credential);
        
        // Update password
        await updatePassword(currentUser, newPassword);
        
        // Show success message
        const successMsg = document.createElement('div');
        successMsg.innerHTML = '<i class="fas fa-check-circle"></i> Password updated successfully!';
        successMsg.style.backgroundColor = 'var(--success)';
        successMsg.style.color = 'white';
        successMsg.style.padding = '10px';
        successMsg.style.borderRadius = '8px';
        successMsg.style.marginTop = '15px';
        successMsg.style.textAlign = 'center';
        passwordForm.appendChild(successMsg);
        
        // Clear form
        currentPasswordInput.value = "";
        newPasswordInput.value = "";
        confirmPasswordInput.value = "";
        strengthMeter.style.width = "0";
        
        // Remove message after 3 seconds
        setTimeout(() => {
          successMsg.remove();
        }, 3000);
      } catch (error) {
        console.error("Password change error:", error);
        
        let errorMessage = "Error changing password. Please try again.";
        if (error.code === "auth/wrong-password") {
          errorMessage = "Current password is incorrect";
        } else if (error.code === "auth/weak-password") {
          errorMessage = "Password is too weak";
        }
        
        alert(errorMessage);
      } finally {
        // Hide spinner
        passwordSpinner.style.display = "none";
      }
    });

    // Navigation handling
    navItems.forEach(item => {
      if (!item.href) {
        item.addEventListener("click", (e) => {
          e.preventDefault();
          const sectionId = item.getAttribute("data-section");
          
          // Update active nav item
          navItems.forEach(nav => nav.classList.remove("active"));
          item.classList.add("active");
          
          // Show the selected section
          contentSections.forEach(section => {
            section.classList.remove("active");
            if (section.id === sectionId) {
              section.classList.add("active");
            }
          });
        });
      }
    });

    // Logout handling
    confirmLogoutBtn.addEventListener("click", () => {
      signOut(auth).then(() => {
        window.location.href = "login.html";
      }).catch((error) => {
        console.error("Logout error:", error);
        alert("Logout failed. Please try again.");
      });
    });

    cancelLogoutBtn.addEventListener("click", () => {
      // Return to profile section
      navItems.forEach(nav => nav.classList.remove("active"));
      navItems[0].classList.add("active");
      
      contentSections.forEach(section => {
        section.classList.remove("active");
        if (section.id === "profile") {
          section.classList.add("active");
        }
      });
    });
  </script>
</body>
</html>