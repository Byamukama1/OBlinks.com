<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Complete Payment - OBlinks</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1e40af;
      --secondary: #64748b;
      --light: #f8fafc;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --border: #e2e8f0;
      --shadow: 0 4px 20px rgba(0,0,0,0.08);
      --radius: 12px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
      min-height: 100vh;
      padding: 20px;
      color: #1e293b;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .container {
      max-width: 520px;
      width: 100%;
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, var(--primary), #3b82f6);
      color: white;
      padding: 20px;
      text-align: center;
    }
    .logo {
      display: flex;
      justify-content: center;
      margin-bottom: 10px;
    }
    .logo-icon {
      background: rgba(255, 255, 255, 0.2);
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    .header h1 { 
      font-weight: 600; 
      font-size: 1.5rem; 
      margin-bottom: 5px; 
    }
    .header p { 
      opacity: 0.9; 
      font-size: 0.9rem; 
    }
    .content { 
      padding: 20px; 
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .info-label {
      color: var(--secondary);
      font-weight: 600;
      margin-bottom: 5px;
      display: block;
      font-size: 0.9rem;
    }
    input {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 5px;
      font-size: 0.95rem;
    }
    .payment-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 5px;
    }
    .payment-option {
      display: flex;
      align-items: center;
      padding: 12px;
      background: #f8fafc;
      border-radius: 8px;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.2s;
    }
    .payment-option.selected {
      background: #e0f2fe;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
    }
    .payment-option i {
      margin-right: 12px;
      font-size: 1.2rem;
      color: var(--primary);
    }
    .payment-option .details {
      flex-grow: 1;
    }
    .payment-option .title {
      font-weight: 600;
      margin-bottom: 2px;
    }
    .payment-option .description {
      font-size: 0.85rem;
      color: var(--secondary);
    }
    .payment-option .radio {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-radius: 50%;
      position: relative;
    }
    .payment-option.selected .radio::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 10px;
      height: 10px;
      background: var(--primary);
      border-radius: 50%;
    }
    .btn-container {
      margin-top: 5px;
    }
    button {
      width: 100%;
      background: linear-gradient(to right, var(--primary), var(--primary-dark));
      color: white;
      border: none;
      padding: 14px;
      border-radius: 50px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    button i {
      margin-right: 10px;
      font-size: 1.1rem;
    }
    .status-msg {
      display: none;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
      background: #f8fafc;
      margin-top: 10px;
      font-size: 0.9rem;
    }
    .status-msg.error {
      border-color: #fecaca;
      background: #fef2f2;
      color: #7f1d1d;
    }
    .status-msg.success {
      border-color: #bbf7d0;
      background: #ecfdf5;
      color: #065f46;
    }
    .country-selector {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      background: #f1f5f9;
      padding: 8px 12px;
      border-radius: 8px;
    }
    .country-selector i {
      margin-right: 10px;
      color: var(--primary);
    }
    .country-selector select {
      background: transparent;
      border: none;
      font-weight: 600;
      color: var(--primary-dark);
      padding: 5px;
      cursor: pointer;
      width: auto;
    }
  </style>
</head>


<body>
  <div class="container">
    <div class="header">
      <div class="logo">
        <div class="logo-icon">
          <i class="fas fa-link"></i>
        </div>
      </div>
      <h1>Complete Payment</h1>
      <p>Secure payment processing with OBlinks</p>
    </div>

    <div class="content">
      <div class="country-selector">
        <i class="fas fa-globe-africa"></i>
        <select id="countrySelect">
          <option value="uganda">Uganda</option>
          <option value="tanzania">Tanzania</option>
          <option value="nigeria">Nigeria</option>
          <option value="ghana">Ghana</option>
        </select>
      </div>
      
      <label class="info-label">Amount to Pay:</label>
      <div id="amountDisplay" style="font-weight: bold; margin-bottom: 5px; font-size: 1.1rem;">Loading...</div>

      <label for="paymentPhone" class="info-label">Payment Phone:</label>
      <input type="text" id="paymentPhone" placeholder="Enter payment phone number" />

      <div class="payment-options" id="paymentOptions">
        <!-- Payment options will be populated by JS -->
      </div>

      <div class="btn-container">
        <button id="payButton">
          <i class="fas fa-lock"></i> Complete Payment
        </button>
      </div>
      
      <div id="statusMsg" class="status-msg"></div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  
  

<script>
  /* =======================
   *  OBlinks – Pay Page JS
   *  Calls your live server:
   *  https://oblinks-new-server-pandora-payments.onrender.com
   * ======================= */

  // === BACKEND ===
  const API_BASE = "https://oblinks-new-server-pandora-payments.onrender.com";

  // === FIREBASE ===
  const firebaseConfig = {
    apiKey: "AIzaSyCGVVpcWS9ae1DH1J8qoaK1TwnSX_W5FkQ",
    authDomain: "oblinks-7fdb1.firebaseapp.com",
    projectId: "oblinks-7fdb1",
    storageBucket: "oblinks-7fdb1.appspot.com",
    messagingSenderId: "587017639779",
    appId: "1:587017639779:web:d11b60f40f431cfc202556"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // === CURRENCY ===
  const currencyData = {
    uganda:   { symbol: "UGX", rate: 1,       format: n => `UGX ${Number(n).toLocaleString()}` },
    tanzania: { symbol: "TZS", rate: 0.63,    format: n => `TZS ${Math.round(n).toLocaleString()}` },
    ghana:    { symbol: "GH₵", rate: 0.00034, format: n => `GH₵ ${Number(n).toFixed(2)}` },
    nigeria:  { symbol: "₦",   rate: 0.42,    format: n => `₦${Math.round(n).toLocaleString()}` }
  };

  // === PAGE STATE ===
  let businessRef = null;
  let currentBusiness = null;
  let selectedPaymentMethod = null;

  let currentCountry = "uganda";
  let amountUGX = 0;     // base price (UGX)
  let amountLocal = 0;   // converted display price
  let currentSymbol = "UGX";

  // === PAYMENT METHODS (Pandora default for Uganda) ===
  const paymentMethods = {
    pandora: {
      id: "pandora",
      title: "Pandora (Mobile Money)",
      description: "Mobile Money for Uganda",
      icon: "fas fa-mobile-alt",
      availableCountries: ["uganda"]
    },
    eversend: {
      id: "eversend",
      title: "Eversend",
      description: "Cards, bank & mobile money",
      icon: "fas fa-globe",
      availableCountries: ["uganda", "tanzania", "ghana", "nigeria"]
    }
  };

  // === UI HELPERS ===
  function showStatusMsg(text, ok = false) {
    const el = document.getElementById("statusMsg");
    el.style.display = "block";
    el.textContent = text;
    el.className = ok ? "status-msg success" : "status-msg error";
  }

  // UG (E.164) + block 079
  function toE164Ug(raw) {
    let p = String(raw || "").replace(/\D/g, "");
    if (/^0\d{8,9}$/.test(p)) p = "256" + p.slice(1);
    if (p.startsWith("25679")) return { valid: false, reason: "079 prefix is not yet supported." };
    if (/^256\d{9}$/.test(p)) return { valid: true, phone: p };
    return { valid: false, reason: "Use 256XXXXXXXXX or 0XXXXXXXXX" };
  }

  // Prefer explicit packageName, else infer from name/narrative
  function pickPackageName(pkgName, narrative) {
    const s = String(pkgName || narrative || "").toLowerCase();
    if (/pro\s*plus/.test(s)) return "Pro Plus";
    if (/standard/.test(s))  return "Standard";
    if (/starter/.test(s))   return "Starter";
    if (/basic/.test(s))     return "Basic";
    if (/pro/.test(s))       return "Pro";
    return (pkgName && String(pkgName)) || "Paid";
  }

  // Hydrate selection from selectpackage.html (sessionStorage)
  function hydrateFromSession() {
    const raw = sessionStorage.getItem("businessSelections");
    if (!raw) return;
    const data = JSON.parse(raw); // { country, package: { name, price, ... } }

    const map = { uganda:"uganda", tanzania:"tanzania", ghana:"ghana", nigeria:"nigeria" };
    currentCountry = map[(data.country || "").toLowerCase()] || "uganda";

    amountUGX = Number(data.package?.price || 0);
    currentSymbol = currencyData[currentCountry].symbol;
    amountLocal = amountUGX * currencyData[currentCountry].rate;

    // UI
    document.getElementById("countrySelect").value = currentCountry;
    document.getElementById("amountDisplay").textContent =
      amountUGX ? currencyData[currentCountry].format(amountLocal) : "Free";
  }

  // Render payment options
  function renderPaymentOptions() {
    const wrap = document.getElementById("paymentOptions");
    wrap.innerHTML = "";

    Object.values(paymentMethods).forEach(m => {
      if (!m.availableCountries.includes(currentCountry)) return;

      const div = document.createElement("div");
      div.className = "payment-option";
      div.dataset.method = m.id;
      div.innerHTML = `
        <i class="${m.icon}"></i>
        <div class="details">
          <div class="title">${m.title}</div>
          <div class="description">${m.description}</div>
        </div>
        <div class="radio"></div>
      `;
      div.onclick = () => {
        document.querySelectorAll(".payment-option").forEach(x => x.classList.remove("selected"));
        div.classList.add("selected");
        selectedPaymentMethod = m.id;
      };
      wrap.appendChild(div);
    });

    // Default selection
    const prefer = currentCountry === "uganda" ? "pandora" : wrap.firstElementChild?.dataset.method;
    if (prefer) {
      selectedPaymentMethod = prefer;
      const el = wrap.querySelector(`[data-method="${prefer}"]`);
      if (el) el.classList.add("selected");
    }
  }

  // COUNTRY CHANGE
  document.getElementById("countrySelect").addEventListener("change", (e) => {
    currentCountry = e.target.value;
    currentSymbol = currencyData[currentCountry].symbol;
    amountLocal = amountUGX * currencyData[currentCountry].rate;
    document.getElementById("amountDisplay").textContent =
      amountUGX ? currencyData[currentCountry].format(amountLocal) : "Free";
    renderPaymentOptions();
  });

  // === PAYMENT FLOW ===
  async function handlePayClick() {
    if (!selectedPaymentMethod) return showStatusMsg("Please select a payment method.");
    const phoneRaw = document.getElementById("paymentPhone").value.trim();
    if (!phoneRaw) return showStatusMsg("Enter your payment phone number.");

    if (selectedPaymentMethod === "pandora") {
      return payWithPandora(phoneRaw);
    }
    return payWithEversend(phoneRaw);
  }

  async function payWithPandora(phoneRaw) {
    if (!businessRef || !currentBusiness) return showStatusMsg("Business not loaded yet.");

    const amount = Number(amountUGX || 0);
    if (!Number.isFinite(amount) || amount < 500) return showStatusMsg("Amount must be ≥ 500 UGX.");

    const p = toE164Ug(phoneRaw);
    if (!p.valid) return showStatusMsg(p.reason);
    const phone = p.phone;

    // Build details for server
    const userId = currentBusiness.userId || "";
    const businessId = currentBusiness.businessId || currentBusiness.id || "";
    const packageName = pickPackageName(
      currentBusiness.package || sessionStorage.getItem("selectedPackageName"),
      `OBlinks - ${currentBusiness.package || ""}`
    );
    const narrative = `OBlinks - ${packageName}`;

    try {
      showStatusMsg("Starting mobile money request… check your phone.");
      // Save intent (optional UI record)
      await db.collection("payments").add({
        provider: "pandora",
        status: "initiated",
        amountPaid: amount,
        currency: "UGX",
        paymentPhone: phone,
        userId, businessId, packageName,
        businessTitle: currentBusiness.title || "",
        timestamp: new Date()
      });

      await businessRef.update?.({ paymentPhone: phone });

      // 🔥 Call your backend correctly
      const resp = await fetch(`${API_BASE}/api/pay`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          amount,
          phone,
          userId,
          businessId,
          packageName,
          narrative
        })
      });

      const dataText = await resp.text();
      let data; try { data = JSON.parse(dataText); } catch { data = null; }

      if (resp.ok && data?.transaction_ref) {
        showStatusMsg("Prompt sent to your phone. Approve to complete payment.", true);
      } else {
        const msg = (data && (data.messages?.join(" ") || data.error)) || dataText || "Payment failed to start.";
        showStatusMsg(msg);
      }
    } catch (err) {
      console.error(err);
      showStatusMsg("Network/server error: " + err.message);
    }
  }

  // Basic passthrough for Eversend (kept for non-Uganda)
  function payWithEversend(phone) {
    if (!businessRef || !currentBusiness) return showStatusMsg("Business not loaded yet.");
    const amount = amountUGX ? Math.max(0, Math.round(amountLocal)) : 0;

    db.collection("payments").add({
      provider: "eversend",
      status: "pending",
      amountPaid: amount,
      currency: currentSymbol,
      paymentPhone: phone,
      businessTitle: currentBusiness.title || "",
      packageName: currentBusiness.package || "",
      userId: currentBusiness.userId || "",
      businessId: currentBusiness.businessId || "",
      timestamp: new Date()
    }).then(async () => {
      await businessRef.update?.({ paymentPhone: phone });
      window.location.href = "https://eversend.me/oblinks";
    }).catch(err => {
      console.error(err);
      showStatusMsg("Error saving payment.");
    });
  }

  // === BOOTSTRAP ===
  document.getElementById("payButton").addEventListener("click", handlePayClick);

  auth.onAuthStateChanged(async (user) => {
    if (!user) {
      alert("Please log in first.");
      location.href = "login.html";
      return;
    }

    // Load latest pending business for this user
    const snap = await db.collection("pendingBusinesses")
      .where("userId", "==", user.uid)
      .where("status", "==", "pending")
      .limit(1)
      .get();

    if (snap.empty) {
      showStatusMsg("No pending business found for your account.");
      return;
    }

    businessRef = snap.docs[0].ref;
    currentBusiness = snap.docs[0].data();
    document.getElementById("paymentPhone").value = currentBusiness.paymentPhone || "";

    hydrateFromSession();
    renderPaymentOptions();
  });
</script>
</body>
</html>